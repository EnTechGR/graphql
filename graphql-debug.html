<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple GraphQL Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4338ca; }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>üß™ Simple GraphQL Test</h1>
    
    <div class="box">
        <h3>Step 1: Check JWT</h3>
        <button onclick="checkJWT()">Check JWT Token</button>
        <div id="jwtResult"></div>
    </div>

    <div class="box">
        <h3>Step 2: Test GraphQL Connection</h3>
        <button onclick="testGraphQL()">Test GraphQL Query</button>
        <div id="graphqlResult"></div>
    </div>

    <div class="box">
        <button onclick="window.location.href='index.html'">‚Üê Back to Login</button>
        <button onclick="clearAndReload()">Clear JWT & Reload</button>
    </div>

    <script>
        // Don't load auth.js - it will redirect!
        
        function checkJWT() {
            const jwt = localStorage.getItem('jwt');
            const resultDiv = document.getElementById('jwtResult');
            
            if (!jwt) {
                resultDiv.innerHTML = '<pre class="error">No JWT token found!\nPlease login first.</pre>';
                return;
            }
            
            try {
                const parts = jwt.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const exp = payload.exp ? new Date(payload.exp * 1000) : null;
                const now = new Date();
                const isExpired = exp && exp < now;
                
                resultDiv.innerHTML = `
                    <pre class="${isExpired ? 'error' : 'success'}">
JWT Token: ${isExpired ? '‚úó EXPIRED' : '‚úì VALID'}

User ID: ${payload.sub || 'N/A'}
Issued: ${payload.iat ? new Date(payload.iat * 1000).toLocaleString() : 'N/A'}
Expires: ${exp ? exp.toLocaleString() : 'N/A'}
${isExpired ? '\n‚ö†Ô∏è Token has expired! Login again.' : ''}

Token Preview:
${jwt.substring(0, 100)}...
                    </pre>
                `;
            } catch (e) {
                resultDiv.innerHTML = `<pre class="error">Error parsing JWT: ${e.message}</pre>`;
            }
        }

        async function testGraphQL() {
            const resultDiv = document.getElementById('graphqlResult');
            const jwt = localStorage.getItem('jwt');
            
            if (!jwt) {
                resultDiv.innerHTML = '<pre class="error">No JWT token! Login first.</pre>';
                return;
            }
            
            resultDiv.innerHTML = '<pre class="info">‚è≥ Testing GraphQL connection...</pre>';
            
            const endpoint = 'http://localhost:8080/api/graphql-engine/v1/graphql';
            const query = `
                query {
                    user {
                        id
                        login
                    }
                }
            `;
            
            console.log('=== GraphQL Test ===');
            console.log('Endpoint:', endpoint);
            console.log('JWT exists:', !!jwt);
            console.log('Query:', query);
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify({ query })
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok && !data.errors) {
                    resultDiv.innerHTML = `
                        <pre class="success">
‚úì GraphQL Query SUCCESS!

Status: ${response.status}
User: ${data.data?.user?.[0]?.login || 'N/A'}
User ID: ${data.data?.user?.[0]?.id || 'N/A'}

Full Response:
${JSON.stringify(data, null, 2)}
                        </pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <pre class="error">
‚úó GraphQL Query FAILED!

Status: ${response.status}
${data.errors ? 'Errors:\n' + JSON.stringify(data.errors, null, 2) : ''}

Full Response:
${JSON.stringify(data, null, 2)}
                        </pre>
                    `;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                resultDiv.innerHTML = `
                    <pre class="error">
‚úó Request FAILED!

Error: ${error.message}
Type: ${error.name}

This usually means:
- Server is not running
- Wrong endpoint URL
- Network/CORS issue

Check the browser console (F12) for more details.
                    </pre>
                `;
            }
        }
        
        function clearAndReload() {
            localStorage.clear();
            location.reload();
        }
        
        // Auto-check JWT on load
        window.addEventListener('load', () => {
            console.log('Simple test page loaded');
            checkJWT();
        });
    </script>
</body>
</html>